# Internationalization (i18n)

> Setup for type-safe internationalization using i18next with React Native. Install required packages: `i18next`, `react-i18next`, `intl-pluralrules`.

## i18next Configuration

### Core Setup

```tsx
// src/core/i18n/index.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import { getLocales } from 'expo-localization';
import { storage } from '@/core/services/storage';
import { resources } from './resources';

const LANGUAGE_KEY = 'app-language';

// Get stored or device language
function getInitialLanguage(): string {
  const stored = storage.getString(LANGUAGE_KEY);
  if (stored) return stored;

  const deviceLocale = getLocales()[0]?.languageTag ?? 'en';
  // Map locale to supported language
  if (deviceLocale.startsWith('zh')) return 'zh-TW';
  if (deviceLocale.startsWith('ja')) return 'ja';
  return 'en';
}

i18n.use(initReactI18next).init({
  resources,
  lng: getInitialLanguage(),
  fallbackLng: 'en',

  // Namespaces
  ns: ['common', 'errors', 'auth', 'settings'],
  defaultNS: 'common',

  interpolation: {
    escapeValue: false, // React already escapes
  },

  // React Native specific
  compatibilityJSON: 'v4',
  react: {
    useSuspense: false,
  },
});

// Language change handler with persistence
export const changeLanguage = async (lang: string) => {
  storage.set(LANGUAGE_KEY, lang);
  await i18n.changeLanguage(lang);
};

export default i18n;
export { useTranslation } from 'react-i18next';
```

### Resource Loader

```tsx
// src/core/i18n/resources.ts
import en_common from '@/../locales/en/common.json';
import en_errors from '@/../locales/en/errors.json';
import en_auth from '@/../locales/en/auth.json';
import en_settings from '@/../locales/en/settings.json';

import zhTW_common from '@/../locales/zh-TW/common.json';
import zhTW_errors from '@/../locales/zh-TW/errors.json';
import zhTW_auth from '@/../locales/zh-TW/auth.json';
import zhTW_settings from '@/../locales/zh-TW/settings.json';

export const resources = {
  en: {
    common: en_common,
    errors: en_errors,
    auth: en_auth,
    settings: en_settings,
  },
  'zh-TW': {
    common: zhTW_common,
    errors: zhTW_errors,
    auth: zhTW_auth,
    settings: zhTW_settings,
  },
} as const;

export type SupportedLanguage = keyof typeof resources;
export const supportedLanguages: SupportedLanguage[] = ['en', 'zh-TW'];
```

## Type-Safe Translations

### Type Definitions

```tsx
// src/core/i18n/types.ts
import type { resources } from './resources';

// Declare module for type inference
declare module 'i18next' {
  interface CustomTypeOptions {
    defaultNS: 'common';
    resources: (typeof resources)['en'];
  }
}

// Helper type for translation keys
export type TranslationKey<NS extends keyof (typeof resources)['en']> =
  keyof (typeof resources)['en'][NS];
```

### Translation File Structure

```json
// locales/en/common.json
{
  "buttons": {
    "submit": "Submit",
    "cancel": "Cancel",
    "save": "Save",
    "delete": "Delete",
    "retry": "Retry"
  },
  "navigation": {
    "home": "Home",
    "settings": "Settings",
    "profile": "Profile",
    "back": "Back"
  },
  "status": {
    "loading": "Loading...",
    "offline": "You are offline",
    "syncing": "Syncing..."
  },
  "time": {
    "now": "Just now",
    "minutes_ago": "{{count}} minute ago",
    "minutes_ago_plural": "{{count}} minutes ago"
  }
}
```

```json
// locales/en/errors.json
{
  "network": {
    "offline": "No internet connection",
    "timeout": "Request timed out",
    "server": "Server error. Please try again."
  },
  "validation": {
    "required": "This field is required",
    "email": "Please enter a valid email",
    "min_length": "Must be at least {{min}} characters"
  },
  "auth": {
    "invalid_credentials": "Invalid email or password",
    "session_expired": "Your session has expired",
    "unauthorized": "You are not authorized"
  }
}
```

```json
// locales/en/auth.json
{
  "login": {
    "title": "Welcome Back",
    "subtitle": "Sign in to continue",
    "email_label": "Email",
    "email_placeholder": "Enter your email",
    "password_label": "Password",
    "password_placeholder": "Enter your password",
    "submit": "Sign In",
    "forgot_password": "Forgot Password?",
    "no_account": "Don't have an account?",
    "sign_up": "Sign Up"
  },
  "register": {
    "title": "Create Account",
    "name_label": "Full Name",
    "submit": "Create Account",
    "has_account": "Already have an account?",
    "sign_in": "Sign In"
  }
}
```

## Usage Patterns

### Basic Usage

```tsx
import { useTranslation } from '@/core/i18n';

export const LoginScreen = () => {
  // Default namespace (common)
  const { t } = useTranslation();

  // Specific namespace
  const { t: tAuth } = useTranslation('auth');
  const { t: tErrors } = useTranslation('errors');

  return (
    <View>
      <Text>{tAuth('login.title')}</Text>
      <Button label={t('buttons.submit')} />
    </View>
  );
};
```

### Multiple Namespaces

```tsx
import { useTranslation } from '@/core/i18n';

export const ProfileScreen = () => {
  // Load multiple namespaces
  const { t } = useTranslation(['common', 'settings']);

  return (
    <View>
      {/* Access different namespaces */}
      <Text>{t('common:navigation.profile')}</Text>
      <Text>{t('settings:theme.title')}</Text>
    </View>
  );
};
```

### Interpolation

```tsx
// With variables
t('greeting', { name: 'John' })
// "Hello, {{name}}!" → "Hello, John!"

// With count (pluralization)
t('time.minutes_ago', { count: 5 })
// 1 → "1 minute ago"
// 5 → "5 minutes ago"

// Nested interpolation
t('errors.validation.min_length', { min: 8 })
// "Must be at least {{min}} characters" → "Must be at least 8 characters"
```

### Pluralization

```json
// locales/en/common.json
{
  "items": {
    "count_zero": "No items",
    "count_one": "{{count}} item",
    "count_other": "{{count}} items"
  },
  "notifications": {
    "unread_one": "You have {{count}} unread notification",
    "unread_other": "You have {{count}} unread notifications"
  }
}
```

```tsx
t('items.count', { count: 0 })  // "No items"
t('items.count', { count: 1 })  // "1 item"
t('items.count', { count: 5 })  // "5 items"
```

## Language Switching

### Language Selector Hook

```tsx
// src/shared/hooks/use-language.ts
import { useTranslation } from 'react-i18next';
import { changeLanguage, supportedLanguages, type SupportedLanguage } from '@/core/i18n';

interface LanguageOption {
  code: SupportedLanguage;
  name: string;
  nativeName: string;
}

const languageOptions: LanguageOption[] = [
  { code: 'en', name: 'English', nativeName: 'English' },
  { code: 'zh-TW', name: 'Chinese (Traditional)', nativeName: '繁體中文' },
];

export function useLanguage() {
  const { i18n } = useTranslation();
  const currentLanguage = i18n.language as SupportedLanguage;

  const setLanguage = async (lang: SupportedLanguage) => {
    await changeLanguage(lang);
  };

  return {
    currentLanguage,
    setLanguage,
    languages: languageOptions,
    isRTL: currentLanguage === 'ar' || currentLanguage === 'he',
  };
}
```

### Language Selector Component

```tsx
// src/features/settings/components/widgets/language-selector.tsx
import { View, Pressable } from 'react-native';
import { Text } from '@/shared/components/ui';
import { useLanguage } from '@/shared/hooks';
import { Check } from 'lucide-react-native';

export const LanguageSelector = () => {
  const { currentLanguage, setLanguage, languages } = useLanguage();

  return (
    <View className="gap-2">
      {languages.map((lang) => (
        <Pressable
          key={lang.code}
          onPress={() => setLanguage(lang.code)}
          className="flex-row items-center justify-between p-4 rounded-xl bg-neutral-100 dark:bg-neutral-800"
        >
          <View>
            <Text className="font-medium">{lang.nativeName}</Text>
            <Text variant="caption">{lang.name}</Text>
          </View>
          {currentLanguage === lang.code && (
            <Check size={20} className="text-primary-500" />
          )}
        </Pressable>
      ))}
    </View>
  );
};
```

## RTL (Right-to-Left) Support

### RTL Configuration

```tsx
// src/core/i18n/utils.ts
import { I18nManager } from 'react-native';
import * as Updates from 'expo-updates';
import { storage } from '@/core/services/storage';

const RTL_LANGUAGES = ['ar', 'he', 'fa', 'ur'];

export function isRTL(language: string): boolean {
  return RTL_LANGUAGES.some((rtl) => language.startsWith(rtl));
}

export async function applyRTL(language: string): Promise<void> {
  const shouldBeRTL = isRTL(language);

  if (I18nManager.isRTL !== shouldBeRTL) {
    I18nManager.allowRTL(shouldBeRTL);
    I18nManager.forceRTL(shouldBeRTL);

    // Requires app reload to apply RTL changes
    await Updates.reloadAsync();
  }
}
```

### RTL-Aware Styling

```tsx
// Using NativeWind with RTL
import { View } from 'react-native';
import { useLanguage } from '@/shared/hooks';

export const ListItem = ({ icon, label }: Props) => {
  const { isRTL } = useLanguage();

  return (
    <View className={`flex-row items-center gap-3 ${isRTL ? 'flex-row-reverse' : ''}`}>
      {icon}
      <Text>{label}</Text>
    </View>
  );
};

// Or use Tailwind RTL variants (NativeWind 4+)
export const DirectionalIcon = () => (
  <View className="rtl:rotate-180">
    <ChevronRight />
  </View>
);
```

### RTL Hook

```tsx
// src/shared/hooks/use-rtl.ts
import { useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import { I18nManager } from 'react-native';

export function useRTL() {
  const { i18n } = useTranslation();

  return useMemo(() => ({
    isRTL: I18nManager.isRTL,
    direction: I18nManager.isRTL ? 'rtl' : 'ltr',
    flexDirection: I18nManager.isRTL ? 'row-reverse' : 'row',
    textAlign: I18nManager.isRTL ? 'right' : 'left',
  }), [i18n.language]);
}
```

## i18n Provider

```tsx
// src/core/providers/i18n-provider.tsx
import { type ReactNode, useEffect, useState } from 'react';
import { I18nextProvider } from 'react-i18next';
import i18n from '@/core/i18n';

interface I18nProviderProps {
  children: ReactNode;
}

export const I18nProvider = ({ children }: I18nProviderProps) => {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    // i18n is already initialized, just mark as ready
    setIsReady(true);
  }, []);

  if (!isReady) return null;

  return (
    <I18nextProvider i18n={i18n}>
      {children}
    </I18nextProvider>
  );
};
```

## Feature Translation Organization

### Namespace per Feature

```
locales/
├── en/
│   ├── common.json         # Shared across app
│   ├── errors.json         # Error messages
│   ├── auth.json           # Auth feature
│   ├── settings.json       # Settings feature
│   ├── transactions.json   # Transactions feature
│   └── profile.json        # Profile feature
└── zh-TW/
    └── ...
```

### Feature-Specific Usage

```tsx
// src/features/auth/components/widgets/login-form.tsx
import { useTranslation } from '@/core/i18n';

export const LoginForm = () => {
  // Use auth namespace for this feature
  const { t } = useTranslation('auth');
  const { t: tCommon } = useTranslation('common');
  const { t: tErrors } = useTranslation('errors');

  return (
    <View>
      <Text variant="h1">{t('login.title')}</Text>

      <Input
        label={t('login.email_label')}
        placeholder={t('login.email_placeholder')}
        error={errors.email && tErrors(`validation.${errors.email.type}`)}
      />

      <Button
        label={tCommon('buttons.submit')}
        onPress={handleSubmit}
      />
    </View>
  );
};
```

## Best Practices

### 1. Key Naming Convention

```json
{
  "feature": {
    "screen": {
      "element": "Text"
    }
  }
}

// Example
{
  "login": {
    "form": {
      "email_label": "Email",
      "email_placeholder": "Enter email"
    }
  }
}
```

### 2. Avoid Hardcoded Strings

```tsx
// ❌ Bad
<Text>Welcome back!</Text>

// ✅ Good
<Text>{t('auth:login.title')}</Text>
```

### 3. Use Namespaces Appropriately

```tsx
// ❌ Bad: Everything in one namespace
t('login_title')
t('login_email_label')
t('settings_theme_title')

// ✅ Good: Feature-based namespaces
t('auth:login.title')
t('auth:login.email_label')
t('settings:theme.title')
```

### 4. Handle Missing Translations

```tsx
// Configure fallback
i18n.init({
  fallbackLng: 'en',
  saveMissing: __DEV__, // Log missing keys in development
  missingKeyHandler: (lng, ns, key) => {
    if (__DEV__) {
      console.warn(`Missing translation: ${lng}/${ns}/${key}`);
    }
  },
});
```

### 5. Date/Number Formatting

```tsx
// src/shared/utils/formatters.ts
import { getLocales } from 'expo-localization';

export function formatDate(date: Date, options?: Intl.DateTimeFormatOptions): string {
  const locale = getLocales()[0]?.languageTag ?? 'en';
  return new Intl.DateTimeFormat(locale, options).format(date);
}

export function formatCurrency(amount: number, currency = 'USD'): string {
  const locale = getLocales()[0]?.languageTag ?? 'en';
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
  }).format(amount);
}

// Usage
formatDate(new Date())           // "1/15/2024" or "2024/1/15"
formatCurrency(1234.56)          // "$1,234.56" or "1,234.56 $"
```
